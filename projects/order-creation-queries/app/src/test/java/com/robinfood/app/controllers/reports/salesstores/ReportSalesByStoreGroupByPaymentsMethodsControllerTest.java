package com.robinfood.app.controllers.reports.salesstores;

import com.robinfood.app.usecases.getreportsalesstores.IGetReportSalesStoreGroupByPaymentMethodsUseCase;
import com.robinfood.core.dtos.reportsalesstore.ReportSalesStoresDTO;
import com.robinfood.core.enums.Result;
import org.apache.http.HttpHeaders;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.test.context.TestPropertySource;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;

import java.time.LocalDateTime;

import static com.robinfood.core.constants.APIConstants.REPORTS_V1;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyLong;
import static org.mockito.Mockito.when;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

@AutoConfigureMockMvc
@SpringBootTest
@TestPropertySource(properties = {
        "jwt-token-prefix=Bearer ",
        "jwt-token-secret=gyXNfCp4Qx4Gn9OV7qK7uwRUX4f4bgrEEPvjdeLQFciHwtCKrc5rCm1kuNECIFP6",
        "jwt-token-aud=internal",
        "jwt-token-mod=order_creation_queries"
})
@ExtendWith(MockitoExtension.class)
public class ReportSalesByStoreGroupByPaymentsMethodsControllerTest {

    private static final String BEARER_AUTH = "Bearer ";

    private static final String
            TOKEN =
            "eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJiYWNrb2ZmaWNlLnYxIiwiYXVkIjoiaW50ZXJuYWwiLCJtb2QiOlsicG9zdjIiLCJvcmNoX21lbnUiLCJvcmNoX29yZGVyIiwib3JkZXJfY3JlYXRpb24iLCJvcmRlcl9jcmVhdGlvbl9xdWVyaWVzIiwiaW50ZWdyYXRpb25zYmFja29mZmljZV9vcl9wbGF0Zm9ybXMiLCJjdXBvbmVzIl0sInBlciI6WyJjb3Vwb25fc3RhdHVzX2NvZGUiLCJjb3Vwb25fc3RvcmVfY29kZSIsImNvdXBvbl9saXN0X2NvZGUiLCJjb3Vwb25fY2hhbmdlX3N0YXR1cyIsImNvdXBvbl9zdG9yZSIsImNvdXBvbl9saXN0IiwiY291cG9uX21vZHVsZSIsImNhbXBhaWduX2NoYW5nZV9zdGF0dXMiLCJjYW1wYWlnbl91cGRhdGUiLCJjYW1wYWlnbl9zdG9yZSIsImNhbXBhaWduX2ZpcnN0X2xpc3QiLCJjYW1wYWlnbl9saXN0IiwiY2FtcGFpZ25fbW9kdWxlIiwib3Jfb3JkZXJfdmFsaWRhdGVfb3JkZXIiLCJvcl9vcmRlcl90YXhlc19saXN0X2Zvcm11bGFfdmFyaWFibGVzIiwiY291cG9uX2ZpcnN0X2xpc3QiLCJjb3Vwb25fdXBkYXRlIiwiY291cG9uX2RlbGV0ZSIsImNvdXBvbl9saXN0X3J1bGUiLCJjb3Vwb25fZmlyc3RfbGlzdF9ydWxlIiwiY291cG9uX3N0b3JlX3J1bGUiLCJjb3Vwb25fdXBkYXRlX3J1bGUiLCJjb3Vwb25fZmlyc3RfbGlzdF9jb2RlIiwiY291cG9uX3VwZGF0ZV9jb2RlIiwiY291cG9uX2RlbGV0ZV9jb2RlIiwiY2FtcGFpZ25fZGVsZXRlIiwicnVsZV90eXBlX2xpc3QiLCJ2YXJpYWJsZV9saXN0IiwiY291cG9uX2RlbGV0ZV9ydWxlIiwiY291cG9uX2NvZGVzX2NyZWF0ZSIsIm9yX29yZGVyX2NoZWNrX3VzZXJfZGF0YSIsIm9yX29yZGVyX2NoZWNrX2NvbXBhbnlfZGF0YSIsIm9yX29yZGVyX3N5bmMiLCJvcl9vcmRlcl9yZWplY3QiLCJjb3Vwb25fY29kZV9yZXBvcnQiLCJvcl9tZW51X3J1bGVfY3JlYXRlIiwib3JfbWVudV9ydWxlX3VwZGF0ZSIsIm9yX21lbnVfcnVsZV9kZWxldGUiLCJvcl9tZW51X2Rpc2NvdW50X2NyZWF0ZSIsIm9yX21lbnVfZGlzY291bnRfdXBkYXRlIiwib3JfbWVudV9kaXNjb3VudF9kZWxldGUiLCJvcl9tZW51X2Rpc2NvdW50X2RldGFpbCIsIm9yX21lbnVfZGlzY291bnRfbGlzdCIsIm9yX21lbnVfZW50aXR5X3J1bGVfbGlzdCIsIm9yX21lbnVfY2FtcGFpZ25fbGlzdCIsIm9yX21lbnVfY2FtcGFpZ25fY3JlYXRlIiwib3JfbWVudV9jYW1wYWlnbl91cGRhdGUiLCJvcl9tZW51X2NhbXBhaWduX2RlbGV0ZSIsIm9yX21lbnVfZGlzY291bnRfdHlwZV9saXN0Iiwib3JfbWVudV9tZW51X2hhbGxfdXBkYXRlIiwib3JfbWVudV9jcml0ZXJpYV9vcGVyYXRvcl9saXN0Iiwib3JfbWVudV9zY2hlZHVsZV9saXN0Iiwib3JfbWVudV9lbnRpdHlfcnVsZV9jcmVhdGUiLCJvcl9tZW51X2VudGl0eV9ydWxlX3VwZGF0ZSIsIm9yX21lbnVfZW50aXR5X3J1bGVfZGVsZXRlIiwib3JfbWVudV9ydWxlX2xpc3QiLCJvcl9tZW51X29yZGVyX3ZhbGlkYXRlIiwib3JfbWVudV9lbnRpdHlfbGlzdCIsIm9yX21lbnVfY291bnRyeV9saXN0Iiwib3JfbWVudV9jcml0ZXJpb25fbGlzdCIsIm9yX21lbnVfY3JpdGVyaW9uX2NyZWF0ZSIsIm9yX21lbnVfY3JpdGVyaW9uX3VwZGF0ZSIsIm9yX21lbnVfY3JpdGVyaW9uX2RlbGV0ZSIsIm9yX21lbnVfbWVudV9jdXJyZW50X2RldGFpbCIsIm9yX21lbnVfbWVudV9mdWxsX2RldGFpbCIsIm9yX21lbnVfc3RvcmVfbGlzdCIsIm9yX21lbnVfc3VnZ2VzdGVkX3BvcnRpb25fbGlzdCIsIm9yX21lbnVfcHJvbW90aW9uX2xpc3QiLCJvcl9tZW51X3Byb21vdGlvbl9jcmVhdGUiLCJvcl9tZW51X3Byb21vdGlvbl91cGRhdGUiLCJvcl9tZW51X3Byb21vdGlvbl9kZWxldGUiLCJvcl9tZW51X21lbnVfaGFsbF9saXN0Iiwib3JfbWVudV9tZW51X2hhbGxfY3JlYXRlIiwib3JfbWVudV9tZW51X2hhbGxfZGVsZXRlIiwib3JfbWVudV9oYWxsX2xpc3QiLCJvcl9tZW51X2hhbGxfY3JlYXRlIiwib3JfbWVudV9oYWxsX3VwZGF0ZSIsIm9yX21lbnVfaGFsbF9kZWxldGUiLCJvcl9tZW51X3Byb2R1Y3RfZGlzcGxheV9saXN0Iiwib3JfbWVudV9wcm9kdWN0X2Rpc3BsYXlfY3JlYXRlIiwib3JfbWVudV9wcm9kdWN0X2Rpc3BsYXlfdXBkYXRlIiwib3JfbWVudV9wcm9kdWN0X2Rpc3BsYXlfZGVsZXRlIiwib3JfbWVudV9zdG9yZV9icmFuZF9saXN0Iiwib3JfbWVudV9zdG9yZV9icmFuZF9jcmVhdGUiLCJvcl9tZW51X3N0b3JlX2JyYW5kX2RlbGV0ZSIsIm9yX21lbnVfbWVudV9oYWxsX3Byb2R1Y3RfbGlzdCIsIm9yX21lbnVfbWVudV9oYWxsX3Byb2R1Y3RfY3JlYXRlIiwib3JfbWVudV9tZW51X2hhbGxfcHJvZHVjdF91cGRhdGUiLCJvcl9tZW51X21lbnVfaGFsbF9wcm9kdWN0X2RlbGV0ZSIsIm9yX21lbnVfc3RvcmVfbWVudV9saXN0Iiwib3JfbWVudV9zdG9yZV9tZW51X2NyZWF0ZSIsIm9yX21lbnVfc3RvcmVfbWVudV9kZWxldGUiLCJvcl9tZW51X3N0b3JlX21lbnVfc2NoZWR1bGVfbGlzdCIsIm9yX21lbnVfc3RvcmVfbWVudV9zY2hlZHVsZV9jcmVhdGUiLCJvcl9tZW51X3N0b3JlX21lbnVfc2NoZWR1bGVfdXBkYXRlIiwib3JfbWVudV9zdG9yZV9tZW51X3NjaGVkdWxlX2RlbGV0ZSIsIm9yX21lbnVfcHJvZHVjdF90eXBlX2xpc3QiLCJvcl9tZW51X3Byb2R1Y3RfdHlwZV9jcmVhdGUiLCJvcl9tZW51X3Byb2R1Y3RfdHlwZV91cGRhdGUiLCJvcl9tZW51X3Byb2R1Y3RfdHlwZV9kZWxldGUiLCJvcl9tZW51X3Byb21vdGlvbl9ncm91cF9saXN0Iiwib3JfbWVudV9wcm9tb3Rpb25fZ3JvdXBfY3JlYXRlIiwib3JfbWVudV9wcm9tb3Rpb25fZ3JvdXBfdXBkYXRlIiwib3JfbWVudV9wcm9tb3Rpb25fZ3JvdXBfZGVsZXRlIiwib3JfbWVudV9mbG93X2xpc3QiLCJvcl9tZW51X2Zsb3dfY3JlYXRlIiwib3JfbWVudV9mbG93X3VwZGF0ZSIsIm9yX21lbnVfZmxvd19kZWxldGUiLCJvcl9tZW51X3Byb21vdGlvbl9hcnRpY2xlX2xpc3QiLCJvcl9tZW51X3Byb21vdGlvbl9hcnRpY2xlX2NyZWF0ZSIsIm9yX21lbnVfcHJvbW90aW9uX2FydGljbGVfdXBkYXRlIiwib3JfbWVudV9wcm9tb3Rpb25fYXJ0aWNsZV9kZWxldGUiLCJvcl9tZW51X21lbnVfbGlzdCIsIm9yX21lbnVfbWVudV9jcmVhdGUiLCJvcl9tZW51X21lbnVfdXBkYXRlIiwib3JfbWVudV9tZW51X2RlbGV0ZSIsIm9yX21lbnVfZGF5X2xpc3QiLCJvcl9tZW51X2RheV9jcmVhdGUiLCJvcl9tZW51X2RheV91cGRhdGUiLCJvcl9tZW51X2RheV9kZWxldGUiLCJvcl9tZW51X2hvbGlkYXlfbGlzdCIsIm9yX21lbnVfaG9saWRheV9jcmVhdGUiLCJvcl9tZW51X2hvbGlkYXlzX3VwZGF0ZSIsIm9yX21lbnVfaG9saWRheV9kZWxldGUiLCJvcl9tZW51X2JyYW5kX2xpc3QiLCJvcl9tZW51X2JyYW5kX2NyZWF0ZSIsIm9yX21lbnVfYnJhbmRfdXBkYXRlIiwib3JfbWVudV9icmFuZF9kZWxldGUiLCJvcl9tZW51X3Byb2R1Y3RfZmxvd19saXN0Iiwib3JfbWVudV9wcm9kdWN0X2Zsb3dfY3JlYXRlIiwib3JfbWVudV9wcm9kdWN0X2Zsb3dfdXBkYXRlIiwib3JfbWVudV9wcm9kdWN0X2Zsb3dfZGVsZXRlIiwib3JfbWVudV9wcm9kdWN0X3RhZ19jcmVhdGUiLCJvcl9tZW51X3Byb2R1Y3RfdGFnX2RlbGV0ZSIsImNvdXBvbl9jb2Rlc19yZXZlcnQiLCJjb3Vwb25fY29kZXNfcmVkZWVtIiwiY291cG9uX2NvZGVzX3ZhbGlkYXRlIiwib3Jfb3JkZXJfY3JlYXRlX3RyYW5zYWN0aW9uIiwib3JfaW50ZWdyYXRpb25zYmFja29mZmljZV9wbGF0Zm9ybV9jcmVhdGUiLCJvcl9pbnRlZ3JhdGlvbnNiYWNrb2ZmaWNlX3BsYXRmb3JtX3VwZGF0ZSIsIm9yX2ludGVncmF0aW9uc2JhY2tvZmZpY2VfcGxhdGZvcm1fZGVsZXRlIiwib3JfaW50ZWdyYXRpb25zYmFja29mZmljZV9wbGF0Zm9ybV9saXN0Iiwib3JfbWVudV9maW5hbF9wcm9kdWN0X3NpemVfbGlzdCIsIm9yX29yZGVyX2xpc3Rfb3JkZXJzIiwib3Jfb3JkZXJfbGlzdF9kZXRhaWwiLCJvcl9vcmRlcl9saXN0X2hpc3RvcnkiLCJvcl9vcmRlcl9saXN0X3ByaW50X29yZGVycyIsImFkX29yZGVyX2xpc3Rfb3JkZXJzIiwiYWRfb3JkZXJfbGlzdF9kZXRhaWwiLCJhZF9vcmRlcl9saXN0X2hpc3RvcnkiLCJhZF9vcmRlcl9saXN0X3ByaW50X29yZGVycyIsImFkX29yZGVyX2NyZWF0ZV90cmFuc2FjdGlvbiIsIm9yX21lbnVfY28yX2NhbGN1bGF0ZSIsIm9yX2NhbXBhaWduX2FyZWFzX2xpc3QiLCJvcl9jb3Vwb25zX3JlZGVlbV9saXN0Iiwib3JfY291cG9uc192YWxpZGF0ZV9saXN0Iiwib3Jfb3JkZXJfZGFpbHlfc2FsZXNfc3VtbWFyeSIsIm9yX29yZGVyX2RhaWx5X3NhbGVzX3BheW1lbnRfbWV0aG9kcyIsIm9yX29yZGVyX2RhaWx5X3NhbGVzX3BheW1lbnRfbWV0aG9kX2dyYXBoaWNzIiwib3Jfb3JkZXJfZmlsdGVyX2ludm9pY2VfdmFsaWRpdHlfbmluZXR5X2RheXMiLCJvcl9vcmRlcl9kYWlseV9yZXBvcnRfdm91Y2hlciIsIm9yX29jcXVlcmllc191c2Vyb3JkZXJfbGlzdCIsIm9yX2NvdXBvbnNfdXNlcmNvZGVzX2xpc3QiLCJvcl9tZW51X2NvbmZpZ3VyYXRpb25fc3RvcmUiLCJvcl9tZW51X3RpbWV6b25lX2xpc3QiLCJvcl9tZW51X2V4Y2x1ZGVfZGlzaF9jcmVhdGUiLCJvcl9tZW51X2V4Y2x1ZGVfZGlzaF91cGRhdGUiLCJvcl9tZW51X2V4Y2x1ZGVfZGlzaF9kZWxldGUiLCJvcl9tZW51X2V4Y2x1ZGVfZGlzaF9saXN0Iiwib3JfbWVudV9leGNsdWRlX2Rpc2hfZGV0YWlsIiwib3JfbWVudV9tZW51X3R5cGVfbGlzdCIsIm9yX21lbnVfc3RpY2tlcl9saXN0Iiwib3JfbWVudV9tZW51X3B1Ymxpc2giLCJvcl9tZW51X21lbnVfcm9sbGJhY2siLCJvcl9tZW51X3N0aWNrZXJfY3JlYXRlIiwib3JfbWVudV9zdGlja2VyX3VwZGF0ZSIsIm9yX21lbnVfc3RpY2tlcl9kZWxldGUiLCJvcl9vcmRlcl9yZXBvcnRfc2FsZXMiXSwianRpIjoiOTZlNzA0YmItOWRiMS00ZDNkLWFhZTYtYzM1MjJhNDE2OGM1IiwiZXhwIjoxNjgxMjgxNjY3LCJpYXQiOjE2ODEyMzg0NjcsIm5iZiI6MCwidXNlciI6eyJjb21wYW5pZXMiOlt7Im5hbWUiOiJNVVkiLCJ0aW1lem9uZSI6IkFtZXJpY2EvQm9nb3RhIiwiaWQiOjF9LHsibmFtZSI6Ik1VWSBNRVhJQ08iLCJ0aW1lem9uZSI6IkFtZXJpY2EvQm9nb3RhIiwiaWQiOjJ9LHsibmFtZSI6Ik1VWSBCUkFTSUwiLCJ0aW1lem9uZSI6IkFtZXJpY2EvU2FvX1BhdWxvIiwiaWQiOjV9XSwidXNlcl9pZCI6NCwicGhvbmUiOiIzMDU4MTQyNjUzIiwiYWxsb3dfYWRtaW4iOnRydWUsImRlZmF1bHRfY29tcGFueV9pZCI6MSwibGVnYWN5X2lkIjoyNiwibGFzdF9uYW1lIjoiU2lsdmEiLCJmaXJzdF9uYW1lIjoiU2VyZ2lvIiwiZW1haWwiOiJzc2lsdmFAbXV5LmNvbS5jbyIsImNvdW50cnlfaWQiOjF9LCJzdWIiOjQsImNvbXBhbnlfaWQiOjF9.7YqwGaQ1-iQ2SvW8yMJM5YDvQgC9x83syUziZmwGBnpIX7qlxuJgqvZvCdCkFUGkgi94kx8YY9VlgLikMQFKFA";

    @Autowired
    private MockMvc mockMvc;

    @MockBean
    private IGetReportSalesStoreGroupByPaymentMethodsUseCase getReportSalesStoreGroupByPaymentMethodsUseCase;

    @Test
    void test_When_getSalesStore_Should_Request_OK() throws Exception {

        when(getReportSalesStoreGroupByPaymentMethodsUseCase.invoke(
                any(LocalDateTime.class),
                anyLong()
        )).thenReturn(new Result.Success<>(ReportSalesStoresDTO.builder().build()));

        mockMvc.perform(MockMvcRequestBuilders
                .get(REPORTS_V1 + "/sales/store/164/payment-methods")
                .param("dateTimeCurrent", "2023-03-14T11:00:00")
                .header(HttpHeaders.AUTHORIZATION, BEARER_AUTH + TOKEN)
                .contentType(MediaType.APPLICATION_JSON)
                .accept(MediaType.APPLICATION_JSON)
        ).andExpect(status().isOk());
    }

    @Test
    void test_getSalesStore_Should_BadRequest_When_EndPointGenerateError() throws Exception {
        when(getReportSalesStoreGroupByPaymentMethodsUseCase.invoke(
                any(LocalDateTime.class),
                anyLong()
        )).thenReturn(new Result.Error(new Exception("Some error"), HttpStatus.BAD_REQUEST));

        mockMvc.perform(MockMvcRequestBuilders
                .get(REPORTS_V1 + "/sales/store/164/payment-methods")
                .param("dateTimeCurrent", "2023-03-14T11:00:00")
                .header(HttpHeaders.AUTHORIZATION, BEARER_AUTH + TOKEN)
                .contentType(MediaType.APPLICATION_JSON)
                .accept(MediaType.APPLICATION_JSON)
        ).andExpect(status().isBadRequest());
    }
}
